<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>IPTV por País y Categoría</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    select {
      margin: 1rem 0;
      padding: 0.5rem;
    }
    .canal {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
    }
    #player {
      margin-top: 2rem;
      width: 100%;
      max-width: 640px;
      height: 360px;
      background: black;
    }
  </style>
</head>
<body>

  <h1>IPTV por País y Categoría</h1>

  <label for="pais">Selecciona País:</label>
  <select id="pais"><option>Cargando...</option></select>

  <br>

  <label for="categoria">Selecciona Categoría:</label>
  <select id="categoria"><option>Cargando...</option></select>

  <div id="resultado"></div>

  <video id="player" controls></video>

  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    const urlPais = 'https://pakogarcia.github.io/mundotv/data/index.country.m3u';
    const urlCategoria = 'https://pakogarcia.github.io/mundotv/data/index.category.m3u';

    let canalesPais = [];
    let canalesCategoria = [];

    async function cargarM3U(url) {
      const response = await fetch(url);
      const texto = await response.text();
      const lineas = texto.split('\n');
      const canales = [];

      for (let i = 0; i < lineas.length; i++) {
        const linea = lineas[i].trim();

        if (linea.startsWith('#EXTINF')) {
          // Extraer atributos con regex flexible
          const info = {};
          const attrRegex = /(\w+?)="(.*?)"/g;
          let match;
          while ((match = attrRegex.exec(linea)) !== null) {
            info[match[1]] = match[2];
          }
          // Extraer título después de la coma
          const tituloMatch = linea.match(/,(.*)$/);
          const titulo = tituloMatch ? tituloMatch[1] : '';

          const urlStream = lineas[i + 1]?.trim();

          if (urlStream) {
            canales.push({
              id: info['tvg-id'] || '',
              nombre: info['tvg-name'] || '',
              pais: info['group-title'] || '', // Aquí está el país en index.country.m3u
              idioma: info['tvg-language'] || '',
              categoria: info['group-title'] || '', // En index.category.m3u el grupo es la categoría
              titulo: titulo,
              url: urlStream
            });
          }
        }
      }
      return canales;
    }

    async function inicializar() {
      [canalesPais, canalesCategoria] = await Promise.all([
        cargarM3U(urlPais),
        cargarM3U(urlCategoria)
      ]);

      // Extraer países únicos de canalesPais (group-title)
      const paises = [...new Set(canalesPais.map(c => c.pais).filter(p => p))].sort();

      // Extraer categorías únicas de canalesCategoria (group-title)
      const categorias = [...new Set(canalesCategoria.map(c => c.categoria).filter(c => c))].sort();

      document.getElementById('pais').innerHTML =
        '<option value="Todos">-- Todos --</option>' +
        paises.map(p => `<option value="${p}">${p}</option>`).join('');

      document.getElementById('categoria').innerHTML =
        '<option value="Todos">-- Todos --</option>' +
        categorias.map(c => `<option value="${c}">${c}</option>`).join('');

      document.getElementById('pais').addEventListener('change', mostrarCanales);
      document.getElementById('categoria').addEventListener('change', mostrarCanales);

      mostrarCanales();
    }

    function mostrarCanales() {
      const paisSel = document.getElementById('pais').value;
      const catSel = document.getElementById('categoria').value;
      const resultado = document.getElementById('resultado');

      // Filtrar canales que coincidan con país y categoría
      const canalesFiltrados = canalesPais.filter(cp =>
        (paisSel === 'Todos' || cp.pais === paisSel) &&
        (catSel === 'Todos' || cp.categoria === catSel)
      );

      if (canalesFiltrados.length === 0) {
        resultado.innerHTML = '<p>No se encontraron canales para esta selección.</p>';
        return;
      }

      resultado.innerHTML = canalesFiltrados.map(c =>
        `<div class="canal">
          <strong>${c.titulo}</strong><br>
          País: ${c.pais}<br>
          Categoría: ${c.categoria}<br>
          <button onclick="reproducirCanal('${c.url}')">▶ Reproducir</button>
          <a href="${c.url}" target="_blank" download>⬇ Descargar</a>
        </div>`
      ).join('');
    }

    function reproducirCanal(url) {
      const video = document.getElementById('player');
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          video.play();
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', function () {
          video.play();
        });
      } else {
        alert("Este navegador no soporta reproducción HLS. Intenta con VLC o apps IPTV.");
      }
    }

    inicializar();
  </script>
</body>
</html>